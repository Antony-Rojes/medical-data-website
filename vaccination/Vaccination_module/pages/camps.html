<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaccination Camps | HealthConnect</title>

    <!-- Main CSS -->
    <link rel="stylesheet" href="../css/main.css">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --page-bg: #f8fafc;
            --medical-gradient: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
        }

        * {
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            overflow-x: hidden;
        }

        .main-wrapper {
            min-height: 100vh;
            background: var(--page-bg);
        }

        /* =========================
           HEADER SECTION - RESPONSIVE FIX
        ========================= */
        .page-header {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .header-text {
            flex: 1;
        }

        .add-btn {
            background: var(--medical-gradient);
            border: none;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(14,165,233,0.25);
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .add-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(14,165,233,0.35);
        }

        /* =========================
           CAMP CARDS
        ========================= */
        .camp-card {
            border-radius: 16px;
            padding: 24px;
            height: 100%;
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background: white;
        }

        .camp-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-color: #0ea5e9;
        }

        /* =========================
           FORM VALIDATION STYLES
        ========================= */
        .form-invalid { 
            border-color: #ef4444 !important; 
            box-shadow: 0 0 0 0.2rem rgba(239,68,68,0.25) !important; 
        }
        
        .form-valid { 
            border-color: #10b981 !important; 
            box-shadow: 0 0 0 0.2rem rgba(16,185,129,0.25) !important; 
        }
        
        .error-message { 
            color: #ef4444; 
            font-size: 0.875rem; 
            margin-top: 0.25rem; 
            display: block; 
        }
        
        .success-message { 
            color: #10b981; 
            font-size: 0.875rem; 
            margin-top: 0.25rem; 
        }

        /* =========================
           RESPONSIVE BREAKPOINTS
        ========================= */

        /* Tablet */
        @media (max-width: 991px) {
            .main-wrapper {
                flex-direction: column;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1.5rem;
            }

            .add-btn {
                width: 100%;
                justify-content: center;
                display: flex;
                align-items: center;
            }
        }

        /* Mobile */
        @media (max-width: 767px) {
            .flex-grow-1 {
                padding: 1.5rem !important;
            }

            .page-header {
                padding-bottom: 1rem;
                margin-bottom: 1.5rem;
            }

            .header-text h1 {
                font-size: 1.75rem !important;
            }

            .header-text p {
                font-size: 0.9rem;
            }

            .add-btn {
                padding: 14px 20px;
                font-size: 15px;
            }

            .camp-card {
                padding: 20px;
                border-radius: 14px;
            }

            .camp-card h5 {
                font-size: 1.1rem;
            }

            .modal-body {
                padding: 1.5rem !important;
            }
        }

        /* Small Mobile */
        @media (max-width: 480px) {
            .flex-grow-1 {
                padding: 1rem !important;
            }

            .page-header {
                gap: 1rem;
            }

            .header-text h1 {
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            .header-text p {
                font-size: 0.85rem;
            }

            .add-btn {
                padding: 12px 18px;
                font-size: 14px;
            }

            .add-btn i {
                font-size: 0.9rem;
            }

            .camp-card {
                padding: 16px;
                border-radius: 12px;
            }

            .camp-card h5 {
                font-size: 1rem;
            }

            .camp-card .small {
                font-size: 0.8rem !important;
            }

            .modal-dialog {
                margin: 0.5rem;
            }

            .modal-body {
                padding: 1rem !important;
            }

            .form-label {
                font-size: 0.9rem;
            }

            .form-control {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
        }

        /* Extra Small */
        @media (max-width: 360px) {
            .header-text h1 {
                font-size: 1.3rem !important;
            }

            .add-btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .camp-card {
                padding: 14px;
            }
        }
    </style>
</head>

<body>
<div class="d-flex main-wrapper">
    <!-- Sidebar -->
    <div>
        <a href="../index.html" class="text-primary fs-3 mb-4">
            <!-- Sidebar content -->
        </a>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 p-5">
        <!-- Header Section - FIXED STRUCTURE -->
        <div class="page-header">
            <div class="header-text">
                <h1 class="fw-bold display-6 mb-1">Active Medical Camps</h1>
                <p class="text-muted mb-0">Explore upcoming health camps or register a new one (Organizers).</p>
            </div>
            <button class="btn add-btn text-white" data-bs-toggle="modal" data-bs-target="#addCampModal">
                <i class="bi bi-plus-circle me-2"></i>Add Camp
            </button>
        </div>

        <!-- Camps Grid -->
        <div class="row g-4" id="campsContainer">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">Loading camps...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Camp Modal -->
<div class="modal fade" id="addCampModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header" style="background: var(--medical-gradient); color: white;">
                <h5 class="modal-title fw-bold">Register New Camp</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- ALL 9 CSV FIELDS -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Camp Title <span class="text-danger">*</span></label>
                    <input type="text" id="cTitle" class="form-control" placeholder="e.g. Village Polio Drive" required>
                    <div class="error-message" id="cTitleError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Date <span class="text-danger">*</span></label>
                    <input type="date" id="cDate" class="form-control" required>
                    <div class="error-message" id="cDateError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Timing <span class="text-danger">*</span></label>
                    <input type="text" id="cTiming" class="form-control" placeholder="e.g. 9 AM - 12 PM" required>
                    <div class="error-message" id="cTimingError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Location <span class="text-danger">*</span></label>
                    <input type="text" id="cLoc" class="form-control" placeholder="City / Venue" required>
                    <div class="error-message" id="cLocError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Purpose <span class="text-danger">*</span></label>
                    <input type="text" id="cPurpose" class="form-control" placeholder="e.g. Polio Vaccination" required>
                    <div class="error-message" id="cPurposeError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Who is conducting <span class="text-danger">*</span></label>
                    <input type="text" id="cBy" class="form-control" placeholder="e.g. City Health Dept" required>
                    <div class="error-message" id="cByError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Who are coming</label>
                    <input type="text" id="cComing" class="form-control" placeholder="e.g. Dr. Rahul">
                    <div class="error-message" id="cComingError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Age Group</label>
                    <input type="text" id="cAge" class="form-control" placeholder="e.g. 0-5 years">
                    <div class="error-message" id="cAgeError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Contact Number</label>
                    <input type="tel" id="cContact" class="form-control" placeholder="e.g. 9876543210">
                    <div class="error-message" id="cContactError"></div>
                </div>
            </div>

            <div class="modal-footer border-0 pb-4">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" onclick="saveCamp()">
                    <span class="spinner-border spinner-border-sm d-none me-2" id="saveSpinner"></span>
                    Save Camp
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ðŸ†• COMPLETE CAMP HANDLER WITH ALL 9 CSV FIELDS (FROM CODE 1)
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('campsContainer');
        
        try {
            // Load CSV data (with fallback)
            let csvData = [];
            try {
                csvData = await getExcelData('../data/Camps.csv');
            } catch (e) {
                console.log('Using hardcoded CSV data');
                csvData = parseCSV(`Title,Date,Timing,Location,Purpose,Who is conducting,Who are coming,Age,Contact Number
Pediatric Pulse Polio,2026-02-15,8 AM - 4 PM,"Community Center, Zone A",Mandatory OPV,City Health Dept,"Dr. Rahul",0-5 years,9876543210
HPV Awareness Camp,2026-02-20,10 AM - 1 PM,St. Mary's School,Cancer prevention,Women's NGO,"Dr. Anita",9-14 years,9876543211
Senior Td Booster,2026-03-05,9 AM - 12 PM,Elder Care Home,Tetanus protection,Red Cross,"Dr. Vikram",60+ years,9876543212`);
            }

            const localData = JSON.parse(localStorage.getItem('myCamps') || '[]');
            const allCamps = [...localData, ...csvData];

            container.innerHTML = '';

            if (allCamps.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-5 text-muted">No camps found.</div>';
                return;
            }

            allCamps.forEach((camp, index) => {
                const isLocal = index < localData.length;
                
                const div = document.createElement('div');
                div.className = 'col-md-6 col-lg-4 mb-4';
                
                div.innerHTML = `
                    <div class="camp-card h-100 shadow-sm" 
                         onclick="location.href='camp-details.html?id=${index}&local=${isLocal}'"
                         style="cursor: pointer; transition: all 0.3s ease;">
                        
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary px-3 py-2 small">
                                <i class="bi bi-calendar3 me-1"></i>${camp.Date || 'N/A'}
                            </span>
                            ${isLocal ? 
                                '<span class="badge bg-warning text-dark small">My Camp</span>' : 
                                '<span class="badge bg-light text-muted border small">Official</span>'
                            }
                        </div>
                        
                        <h5 class="fw-bold mb-3">${camp.Title || 'Untitled'}</h5>
                        
                        <div class="text-muted mb-2 small">
                            <i class="bi bi-geo-alt me-1 text-danger"></i>
                            ${camp.Location || 'N/A'}
                        </div>
                        
                        <div class="text-muted mb-3 small">
                            <i class="bi bi-clock me-1 text-info"></i>
                            ${camp.Timing || 'N/A'}
                        </div>
                        
                        <div class="mt-auto pt-3 border-top d-flex align-items-center justify-content-between">
                            <div>
                                <p class="text-uppercase mb-1 tiny text-muted fw-bold" style="font-size: 0.7rem;">By</p>
                                <p class="mb-0 small fw-semibold text-primary">${camp['Who is conducting'] || 'N/A'}</p>
                            </div>
                            <i class="bi bi-arrow-right-circle fs-4 text-primary opacity-50"></i>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

        } catch (error) {
            console.error('Error loading camps:', error);
            container.innerHTML = '<div class="col-12 text-center py-5"><div class="alert alert-warning">Failed to load camps. Please refresh.</div></div>';
        }
    });

    // ðŸ†• COMPLETE FORM VALIDATION + SAVE FUNCTION (FROM CODE 1)
    function saveCamp() {
        // Clear previous errors
        clearFormErrors();

        const spinner = document.getElementById('saveSpinner');
        const saveBtn = event.target;
        
        // Show loading
        spinner.classList.remove('d-none');
        saveBtn.disabled = true;

        // Get ALL form values matching CSV structure
        const newCamp = {
            "Title": document.getElementById('cTitle').value.trim(),
            "Date": document.getElementById('cDate').value,
            "Timing": document.getElementById('cTiming').value.trim(),
            "Location": document.getElementById('cLoc').value.trim(),
            "Purpose": document.getElementById('cPurpose').value.trim(),
            "Who is conducting": document.getElementById('cBy').value.trim(),
            "Who are coming": document.getElementById('cComing').value.trim() || 'Staff',
            "Age": document.getElementById('cAge').value.trim() || 'All Ages',
            "Contact Number": document.getElementById('cContact').value.trim() || 'Venue Contact'
        };

        // VALIDATE REQUIRED FIELDS
        const requiredFields = [
            { id: 'cTitle', name: 'Camp Title' },
            { id: 'cDate', name: 'Date' },
            { id: 'cTiming', name: 'Timing' },
            { id: 'cLoc', name: 'Location' },
            { id: 'cPurpose', name: 'Purpose' },
            { id: 'cBy', name: 'Conducted By' }
        ];

        let isValid = true;
        requiredFields.forEach(field => {
            const value = document.getElementById(field.id).value.trim();
            if (!value) {
                showFieldError(field.id, `${field.name} is required`);
                isValid = false;
            }
        });

        // Validate date (not in past)
        const campDate = new Date(document.getElementById('cDate').value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (campDate < today) {
            showFieldError('cDate', 'Date cannot be in the past');
            isValid = false;
        }

        // Validate phone number format
        const phone = document.getElementById('cContact').value.trim();
        if (phone && !/^\d{10}$/.test(phone.replace(/\D/g, ''))) {
            showFieldError('cContact', 'Enter valid 10-digit phone number');
            isValid = false;
        }

        if (!isValid) {
            spinner.classList.add('d-none');
            saveBtn.disabled = false;
            return;
        }

        // SAVE TO LOCALSTORAGE
        try {
            const currentCamps = JSON.parse(localStorage.getItem('myCamps') || '[]');
            currentCamps.unshift(newCamp); // Add to top
            localStorage.setItem('myCamps', JSON.stringify(currentCamps));
            
            // Success feedback
            document.querySelector('#addCampModal .modal-body').innerHTML = `
                <div class="alert alert-success text-center py-4">
                    <i class="bi bi-check-circle-fill fs-1 mb-3 text-success"></i>
                    <h5>Camp Added Successfully!</h5>
                    <p class="mb-0">${newCamp.Title} has been added to your camps.</p>
                    <button class="btn btn-success mt-3" onclick="location.reload()">View All Camps</button>
                </div>
            `;
            
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCampModal'));
                modal.hide();
                location.reload();
            }, 2000);

        } catch (error) {
            console.error('Save error:', error);
            alert('Failed to save camp. Please try again.');
            spinner.classList.add('d-none');
            saveBtn.disabled = false;
        }
    }

    // Helper functions
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorEl = document.getElementById(fieldId + 'Error');
        field.classList.add('form-invalid');
        field.classList.remove('form-valid');
        errorEl.textContent = message;
    }

    function clearFormErrors() {
        document.querySelectorAll('.form-control').forEach(field => {
            field.classList.remove('form-invalid', 'form-valid');
        });
        document.querySelectorAll('.error-message').forEach(el => {
            el.textContent = '';
        });
    }

    // CSV Parser fallback
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',');
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const obj = {};
            headers.forEach((header, idx) => {
                obj[header.trim()] = values[idx]?.trim() || '';
            });
            data.push(obj);
        }
        return data;
    }

    // getExcelData function (assumes it's in main.css or define it here)
    async function getExcelData(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch CSV');
        const text = await response.text();
        return parseCSV(text);
    }

    // Form field listeners for real-time validation
    document.querySelectorAll('.form-control[required]').forEach(field => {
        field.addEventListener('blur', function() {
            if (this.value.trim()) {
                this.classList.remove('form-invalid');
                this.classList.add('form-valid');
                document.getElementById(this.id + 'Error').textContent = '';
            }
        });
    });
</script>
</body>
</html>